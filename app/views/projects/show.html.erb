<!-- app/views/projects/show.html.erb -->
<div class="container mx-auto px-4 py-8" data-controller="order-form">
  <!-- Project Information Section -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-8">
    <div class="border-b border-gray-200 pb-4 mb-4">
      <h1 class="text-3xl font-bold text-gray-900 mb-2"><%= @project.name %></h1>
      <div class="text-gray-600">
        <%= @project.description %>
      </div>
    </div>
  </div>

  <!-- Order Form -->
  <%= form_with model: [@order], local: true, data: { turbo: false }, class: "space-y-8" do |form| %>
    <%= form.hidden_field :project_id, value: @project.id %>
    
    <!-- Delivery Date -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Order Details</h2>
      <div class="mb-4">
        <%= form.label :delivery_date, class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= form.date_field :delivery_date, 
            class: "bg-pink-50 border border-pink-300 text-pink-900 text-sm rounded-lg focus:ring-pink-500 focus:border-pink-500 block p-2.5",
            required: true %>
        <%= form.hidden_field :project_id, value: @project.id %>
      </div>
    </div>

    <!-- Products Section -->
    <div class="space-y-8">
      <% @project.products.each_with_index do |product, product_index| %>
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100 product-card" 
            data-controller="product-order" 
            data-product-id="<%= product.id %>"
            data-base-price="<%= product.base_price %>"
            data-bulk-price="<%= product.bulk_prices.to_json %>"
            data-minimum-order="<%= product.minimum_order %>"
            data-sizes="<%= product.sizes.to_json %>"
            data-order-item-index="<%= product_index * 100 %>">
            
          <!-- Product Header -->
          <div class="bg-gray-50 border-b border-gray-200 p-6">
            <div class="flex flex-col lg:flex-row gap-6">
              <!-- Product Images -->
              <% if product.drive_files.any? %>
                <div class="flex gap-3 flex-shrink-0">
                  <% product.drive_files.first(3).each_with_index do |drive_file, index| %>
                    <div class="relative group">
                      <%= image_tag drive_file.preview_url, 
                          alt: product.name, 
                          class: "w-24 h-24 lg:w-32 lg:h-32 object-cover rounded-lg shadow-sm border border-gray-200", 
                          referrerpolicy: "no-referrer" %>
                      <% if index == 0 && product.drive_files.count > 3 %>
                        <div class="absolute inset-0 bg-black/40 rounded-lg flex items-center justify-center">
                          <span class="text-white text-sm font-medium">+<%= product.drive_files.count - 3 %> more</span>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% end %>
              
              <!-- Product Info -->
              <div class="flex-grow">
                <div class="flex items-start justify-between mb-3">
                  <h2 class="text-xl lg:text-2xl font-bold text-gray-900"><%= product.name %></h2>
                  <span class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm font-medium">
                    ID: #<%= product.id %>
                  </span>
                </div>
                
                <p class="text-gray-600 mb-4">
                  <%= product.description %>
                </p>
                
                <!-- Quick Stats -->
                <div class="grid grid-cols-3 gap-4 text-sm">
                  <div>
                    <span class="font-medium text-gray-700">Base Price:</span>
                    <div class="text-lg font-semibold text-pink-600">$<%= product.base_price %></div>
                  </div>
                  <div>
                    <span class="font-medium text-gray-700">Min Order:</span>
                    <div class="text-lg font-semibold text-gray-900"><%= product.minimum_order %> pcs</div>
                  </div>
                  <div>
                    <span class="font-medium text-gray-700">Sizes:</span>
                    <div class="text-lg font-semibold text-gray-900"><%= product.sizes.count %> available</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="p-6 lg:p-8">
            <!-- Product Details Section -->
            <div class="grid lg:grid-cols-2 gap-8 mb-8">
              <!-- Available Sizes -->
              <div class="space-y-4">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                  <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                  </svg>
                  Available Sizes
                </h3>
                <div class="flex flex-wrap gap-2">
                  <% product.sizes.each do |size| %>
                    <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-gray-100 text-gray-800 border border-gray-200">
                      <%= size %>
                    </span>
                  <% end %>
                </div>
              </div>

              <!-- Color Selection -->
              <div class="space-y-4">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                  <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM21 5a2 2 0 00-2-2h-4a2 2 0 00-2 2v12a4 4 0 004 4h4a2 2 0 002-2V5z"></path>
                  </svg>
                  Select Color
                </h3>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
                  <% product.colors.each do |color| %>
                    <button type="button" 
                            class="color-selector group relative flex items-center gap-3 p-3 border-2 border-gray-200 rounded-xl hover:border-indigo-400 hover:bg-indigo-50 focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200"
                            data-action="click->product-order#selectColor"
                            data-color="<%= color['name'] %>"
                            data-hex="<%= color['hex_color'] %>">
                      <div class="w-6 h-6 rounded-full border-2 border-white shadow-md flex-shrink-0" 
                          style="background-color: <%= color['hex_color'] %>"></div>
                      <span class="text-sm font-medium text-gray-700 group-hover:text-indigo-700 truncate">
                        <%= color['name'].try(:capitalize) %>
                      </span>
                      <!-- Selected indicator -->
                      <div class="absolute top-2 right-2 w-4 h-4 bg-indigo-600 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center justify-center">
                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                        </svg>
                      </div>
                    </button>
                  <% end %>
                </div>
              </div>
            </div>

            <!-- Bulk Pricing Section -->
            <% if product.bulk_prices.present? %>
              <div class="mb-4 bg-blue-50 rounded-lg p-3">
                <h4 class="font-medium text-gray-900 text-sm mb-3">Bulk Pricing</h4>
                
                <div class="space-y-2">
                  <% product.bulk_prices.sort_by { |bulk| bulk["qty"].to_i }.each do |bulk| %>
                    <div class="flex justify-between items-center text-sm">
                      <span class="text-gray-700"><%= bulk["qty"] %>+ units</span>
                      <span class="font-semibold text-gray-900"><%= sprintf("%.2f", bulk["price"].to_f) %></span>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>

            <!-- Action Section -->
            <div class="border-t border-gray-200 pt-4 mb-6">
              <button type="button" 
                      class="add-item-btn bg-pink-600 hover:bg-pink-700 text-white px-6 py-2 rounded-lg text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200"
                      data-action="click->product-order#addColorItem"
                      disabled>
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                  </svg>
                  <span class="group-disabled:hidden">Add Selected Color</span>
                  <span class="hidden group-disabled:inline">Select a Color First</span>
                </span>
              </button>
            </div>

            <!-- Order Items Container -->
            <div class="order-items-container mt-8 space-y-4" data-product-order-target="itemsContainer">
              <!-- Dynamic order items will be added here -->
            </div>

            <!-- Hidden fields for order items -->
            <div data-product-order-target="hiddenFields"></div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Order Summary 
    <div class="order-summary rounded-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-gray-900">Order Summary</h3>
        <div class="text-right">
          <div class="text-3xl font-bold text-pink-600" data-order-form-target="grandTotal">$0.00</div>
          <div class="text-sm text-gray-600">Total Estimation Amount</div>
        </div>
      </div>
    -->
    <!-- Hidden field for total price -->
    <%#= form.hidden_field :price, data: { "order-form-target": "priceField" } %>
    <%= form.hidden_field :total_quantity, data: { "order-form-target": "quantityField" } %>

    <div class="flex flex-col sm:flex-row gap-4 justify-end">
      <%= link_to "Cancel", @project, class: "px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-center transition-colors duration-200" %>
      <button type="button"
              class="submit-btn px-6 py-3 bg-pink-600 hover:bg-pink-700 text-white rounded-lg font-medium disabled:opacity-50 transition-all duration-200",
              data-order-form-target="submitBtn"
              data-action="click->order-form#validateAndConfirm">
        Create Order
      </button>
    </div>
    <!-- Confirmation Modal -->
    <div id="order-confirmation-modal"
        class="fixed inset-0 bg-white/30 backdrop-blur-sm flex items-center justify-center z-50 hidden"
        data-order-form-target="modal">
      <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full mx-4 overflow-hidden transform transition-all">
        <div class="px-6 py-5">
          <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
            <div class="flex items-start gap-3">
              <svg class="w-5 h-5 text-amber-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                      d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                      clip-rule="evenodd"/>
              </svg>
              <div>
                <h5 class="font-medium text-amber-800">Important Notice</h5>
                <p class="text-sm text-amber-700 mt-1">
                  Once submitted, this order cannot be modified.  
                  Please double-check all details before confirming.
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal Actions -->
        <div class="bg-gray-50 px-6 py-4 flex gap-3 justify-end">
          <button type="button"
                  class="px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors duration-200"
                  data-action="click->order-form#closeConfirmation">
            Review Order
          </button>
          <%= form.submit "Confirm & Submit Order",
              class: "px-5 py-2 bg-pink-600 hover:bg-pink-700 text-white rounded-lg font-medium transition-colors duration-200" %>
        </div>
      </div>
    </div>
  <% end %>
</div>
