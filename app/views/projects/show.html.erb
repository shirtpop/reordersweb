<!-- app/views/projects/show.html.erb -->
<div class="container mx-auto px-4 py-8" data-controller="order-form">
  <!-- Project Information Section -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-8">
    <div class="border-b border-gray-200 pb-4 mb-4">
      <h1 class="text-3xl font-bold text-gray-900 mb-2"><%= @project.name %></h1>
      <div class="text-gray-600">
        <%= @project.description %>
      </div>
    </div>
  </div>

  <!-- Order Form -->
  <%= form_with model: [@order], local: true, data: { turbo: false }, class: "space-y-8" do |form| %>
    <%= form.hidden_field :project_id, value: @project.id %>
    
    <!-- Delivery Date -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Order Details</h2>
      <div class="mb-4">
        <%= form.label :delivery_date, class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= form.date_field :delivery_date, 
            class: "bg-pink-50 border border-pink-300 text-pink-900 text-sm rounded-lg focus:ring-pink-500 focus:border-pink-500 block p-2.5",
            required: true %>
        <%= form.hidden_field :project_id, value: @project.id %>
      </div>
    </div>

    <!-- Products Section -->
    <div class="space-y-6">
      <% @project.products.each_with_index do |product, product_index| %>
        <div class="bg-white rounded-lg shadow-md p-6 product-card" 
             data-controller="product-order" 
             data-product-id="<%= product.id %>"
             data-base-price="<%= product.base_price %>"
             data-bulk-price="<%= product.bulk_prices.to_json %>"
             data-minimum-order="<%= product.minimum_order %>"
             data-sizes="<%= product.sizes.to_json %>"
             data-order-item-index="<%= product_index * 100 %>">
             
          <!-- Product Header -->
          <div class="flex flex-col lg:flex-row gap-6 mb-6">
            <% if product.drive_files.any? %>
              <div class="flex-shrink-0">
                <%= image_tag product.drive_files.first.preview_url, alt: product.name, class: "w-32 h-32 object-cover rounded-lg shadow-sm", referrerpolicy: "no-referrer" %>
              </div>
            <% end %>
            
            <div class="flex-grow">
              <h3 class="text-xl font-semibold text-gray-900 mb-2"><%= product.name %></h3>
              <div class="text-gray-600 mb-4">
                <%= product.description %>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div>
                  <span class="font-medium text-gray-700">Base Price:</span>
                  <span class="text-pink-600 font-semibold">$<%= product.base_price %></span>
                </div>
                <div>
                  <span class="font-medium text-gray-700">Min Order:</span>
                  <span class="text-gray-600"><%= product.minimum_order %> pcs</span>
                </div>
                <div>
                  <span class="font-medium text-gray-700">Available Sizes:</span>
                  <span class="text-gray-600"><%= product.sizes.join(", ") %></span>
                </div>
              </div>

              <!-- Bulk Pricing -->
              <% if product.bulk_prices %>
                <div class="mt-3">
                  <span class="font-medium text-gray-700 text-sm">Bulk Pricing:</span>
                  <div class="flex flex-wrap gap-2 mt-1">
                    <% product.bulk_prices.each do |bulk| %>
                      <span class="bulk-pricing-badge">
                        <%= bulk["qty"] %>: $<%= bulk["price"] %>
                      </span>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>

          <!-- Color Selection -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-3">Select Color:</label>
            <div class="flex flex-wrap gap-3">
              <% product.colors.each do |color| %>
                <button type="button" 
                        class="color-selector flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-lg hover:border-pink-500 focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all duration-200"
                        data-action="click->product-order#selectColor"
                        data-color="<%= color['name'] %>"
                        data-hex="<%= color['hex_color'] %>">
                  <div class="color-circle" style="background-color: <%= color['hex_color'] %>"></div>
                  <span class="text-sm font-medium"><%= color['name'].try(:capitalize) %></span>
                </button>
              <% end %>
            </div>
          </div>

          <!-- Add Item Button -->
          <button type="button" 
                  class="add-item-btn bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded-lg text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed mb-4 transition-all duration-200"
                  data-action="click->product-order#addColorItem"
                  disabled>
            <span class="flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              Add Selected Color
            </span>
          </button>

          <!-- Order Items Container -->
          <div class="order-items-container space-y-4" data-product-order-target="itemsContainer"></div>

          <!-- Product Total 
          <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="flex justify-between items-center">
              <span class="font-medium text-gray-700">Product Total:</span>
              <span class="product-total font-semibold text-lg text-pink-600" data-product-order-target="productTotal">$0.00</span>
            </div>
          </div>
          -->
          <!-- Hidden fields for order items -->
          <div data-product-order-target="hiddenFields"></div>
        </div>
      <% end %>
    </div>

    <!-- Order Summary 
    <div class="order-summary rounded-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-gray-900">Order Summary</h3>
        <div class="text-right">
          <div class="text-3xl font-bold text-pink-600" data-order-form-target="grandTotal">$0.00</div>
          <div class="text-sm text-gray-600">Total Estimation Amount</div>
        </div>
      </div>
    -->
      <!-- Hidden field for total price -->
      <%#= form.hidden_field :price, data: { "order-form-target": "priceField" } %>
      <%= form.hidden_field :total_quantity, data: { "order-form-target": "quantityField" } %>

      <div class="flex flex-col sm:flex-row gap-4 justify-end">
        <%= link_to "Cancel", @project, class: "px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-center transition-colors duration-200" %>
        <%= form.submit "Create Order", 
            class: "submit-btn px-6 py-3 bg-pink-600 hover:bg-pink-700 text-white rounded-lg font-medium disabled:opacity-50 transition-all duration-200",
            data: { 
              "order-form-target": "submitBtn",
              action: "click->order-form#validateForm"
            },
            disabled: false %>
      </div>
    </div>
  <% end %>
</div>