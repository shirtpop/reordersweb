#!/bin/bash
set -e

# Extract host:port from DATABASE_URL
if [[ -n "$DATABASE_URL" ]]; then
  DB_HOST_PORT=$(echo "$DATABASE_URL" | awk -F[@/] '{print $4}')
  /usr/local/bin/wait-for-it "$DB_HOST_PORT" -t 30
fi

# Run migrations on first deploy
if [[ -f /rails/tmp/initialized ]] || [[ "$KAMAL_RUN_MIGRATIONS" == "1" ]]; then
  bundle exec rails db:migrate
  touch /rails/tmp/initialized
fi

exec "$@"